[tox]
envlist =
    py{27,34,35,36,37},
    bandit, doc8, readme, docs,
    {flake8,pylint}{,-tests},
    # prone to false positives
    vulture

# Additional test environments:
#
# vulture :: Runs vulture. Prone to false-positives.
# linters :: Runs all linters over all source code.
# linters-tests :: Runs all linters over all tests.

# Autoformatter helper environments:
#
# autoformat : Apply all autoformatters
#
# black-check : Check for "black" issues
# blacken : Fix all "black" issues
#
# isort-seed : Generate a known_third_party list for isort.
#   NOTE: make the "known_third_party = " line in setup.cfg before running this
#   NOTE: currently it incorrectly identifies this library too; make sure you remove it
# isort-check : Check for isort issues
# isort : Fix isort issues

# Operational helper environments:
#
# build :: Builds source and wheel dist files.

[testenv:base-command]
commands = pytest --basetemp={envtmpdir} -l --cov busy_engineers_workshop test/ {posargs}

[testenv]
passenv =
    # Pass through AWS credentials
    AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN \
    # Pass through AWS profile name (useful for local testing)
    AWS_PROFILE
sitepackages = False
deps = -rtest/requirements.txt
commands = {[testenv:base-command]commands}

# mypy
[testenv:mypy-coverage]
commands =
    # Make mypy linecoverage report readable by coverage
    python -c \
        "t = open('.coverage', 'w');\
        c = open('build/coverage.json').read();\
        t.write('!coverage.py: This is a private format, don\'t read it directly!\n');\
        t.write(c);\
        t.close()"
    coverage report -m

[testenv:mypy-common]
basepython = python3
deps =
    coverage
    mypy>=0.600
    mypy_extensions
    typing>=3.6.2

[testenv:mypy-py3]
basepython = {[testenv:mypy-common]basepython}
deps = {[testenv:mypy-common]deps}
commands =
    python -m mypy \
        --linecoverage-report build \
        src/busy_engineers_workshop/ \
        {posargs}
    {[testenv:mypy-coverage]commands}

[testenv:mypy-py2]
basepython = {[testenv:mypy-common]basepython}
deps = {[testenv:mypy-common]deps}
commands =
    python -m mypy \
        --py2 \
        --linecoverage-report build \
        src/busy_engineers_workshop/ \
        {posargs}
    {[testenv:mypy-coverage]commands}

# Linters
[testenv:flake8]
basepython = python3
deps =
    flake8
    flake8-docstrings
    # https://github.com/JBKahn/flake8-print/pull/30
    flake8-print>=3.1.0
commands =
    flake8 \
        src/busy_engineers_workshop/ \
        setup.py \
        {posargs}

[testenv:flake8-tests]
basepython = {[testenv:flake8]basepython}
deps =
    flake8
commands =
    flake8 \
        # Ignore F811 redefinition errors in tests (breaks with pytest-mock use)
        # E203 is not PEP8 compliant https://github.com/ambv/black#slices
        # W503 is not PEP8 compliant https://github.com/ambv/black#line-breaks--binary-operators
        --ignore F811,E203,W503 \
        test/ \
        {posargs}

[testenv:pylint]
basepython = python3
deps =
    -rtest/requirements.txt
    pyflakes
    pylint
commands =
    pylint \
        --rcfile=src/pylintrc \
        src/busy_engineers_workshop/  \
        setup.py \
        {posargs}

[testenv:pylint-tests]
basepython = {[testenv:pylint]basepython}
deps = {[testenv:pylint]deps}
commands =
    pylint \
        --rcfile=test/pylintrc \
        test/unit/ \
        test/functional/ \
        test/integration/ \
        {posargs}

[testenv:blacken-src]
basepython = python3
deps =
    black
commands =
    black --line-length 120 \
        src/busy_engineers_workshop/ \
        setup.py \
        test/ \
        deploy-tools/ \
        {posargs}


[testenv:blacken]
basepython = python3
deps =
    {[testenv:blacken-src]deps}
commands =
    {[testenv:blacken-src]commands}

[testenv:black-check]
basepython = python3
deps =
    {[testenv:blacken]deps}
commands =
    {[testenv:blacken-src]commands} --diff

[testenv:isort-seed]
basepython = python3
deps = seed-isort-config
commands = seed-isort-config

[testenv:isort]
basepython = python3
deps = isort
commands = isort -rc \
    src \
    test \
    setup.py \
    deploy-tools \
    {posargs}

[testenv:isort-check]
basepython = python3
deps = {[testenv:isort]deps}
commands = {[testenv:isort]commands} -c

[testenv:autoformat]
basepython = python3
deps =
    {[testenv:blacken]deps}
    {[testenv:isort]deps}
commands =
    {[testenv:blacken]commands}
    {[testenv:isort]commands}

[testenv:readme]
basepython = python3
deps = readme_renderer
commands = python setup.py check -r -s

[testenv:bandit]
basepython = python3
deps =
    # Pull bandit from github because they haven't published 1.4.1 to pypi yet
    git+git://github.com/PyCQA/bandit.git@master
commands = bandit -r src/busy_engineers_workshop/

# Prone to false positives: only run independently
[testenv:vulture]
basepython = python3
deps = vulture
commands = vulture src/busy_engineers_workshop/

[testenv:linters]
basepython = python3
deps =
    {[testenv:flake8]deps}
    {[testenv:pylint]deps}
    {[testenv:readme]deps}
    {[testenv:bandit]deps}
commands =
    {[testenv:flake8]commands}
    {[testenv:pylint]commands}
    {[testenv:readme]commands}
    {[testenv:bandit]commands}

[testenv:linters-tests]
basepython = python3
deps =
    {[testenv:flake8-tests]deps}
    {[testenv:pylint-tests]deps}
commands =
    {[testenv:flake8-tests]commands}
    {[testenv:pylint-tests]commands}

# Build and deploy tooling
[testenv:build]
basepython = python3
skip_install = true
deps =
    wheel
    setuptools
commands =
    python setup.py sdist bdist_wheel


[testenv:build-lambda-remote]
basepython = python3.6
skip_install = true
deps =
whitelist_externals = rm
commands =
    rm -rf {toxinidir}/dist
    {[testenv:build]commands}
    {toxinidir}/build-tools/python-build-remote.sh {posargs}


[testenv:build-lambda-local]
basepython = python3.6
skip_install = true
deps =
whitelist_externals = rm
commands =
    rm -rf {toxinidir}/dist
    {[testenv:build]commands}
    {toxinidir}/build-tools/python-build-local.sh {posargs}


[testenv:deploy]
basepython = python3.6
skip_install = true
deps = boto3
whitelist_externals = {[testenv:build-lambda-local]whitelist_externals}
commands =
    {[testenv:build-lambda-local]commands}
    python {toxinidir}/deploy-tools/deployer.py deploy \
        --config {toxinidir}/deploy.config \
        --lambda-zip {toxinidir}/busy_engineers_workshop_artifacts/busy_engineers_workshop_python.zip


[testenv:deploy-remote-build]
basepython = python3.6
skip_install = true
deps = boto3
whitelist_externals = {[testenv:build-lambda-remote]whitelist_externals}
commands =
    {[testenv:build-lambda-remote]commands} {posargs}
    python {toxinidir}/deploy-tools/deployer.py deploy \
        --config {toxinidir}/deploy.config \
        --lambda-zip {toxinidir}/busy_engineers_workshop_artifacts/busy_engineers_workshop_python.zip


[testenv:destroy]
basepython = python3
skip_install = true
deps = boto3
commands =
    python {toxinidir}/deploy-tools/deployer.py destroy \
        --config {toxinidir}/deploy.config
